"use client"

import type React from "react"

import { useState, useEffect } from "react"
import { useSearchParams, useRouter } from "next/navigation"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { hashPassword, isTokenExpired, formatExpirationTime } from "@/lib/password-utils"
import { sendEmailClient } from "@/lib/email-client"
import { AlertCircle, CheckCircle, Eye, EyeOff, Clock } from "lucide-react"
import { firebaseAuth, firestore } from "@/lib/firebase"
import { confirmPasswordReset, verifyPasswordResetCode, updatePassword, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "firebase/auth"
import { collection, query, where, getDocs, doc, updateDoc } from "firebase/firestore"

// Definir tipo auxiliar para os dados do usu√°rio
interface UsuarioFirestore {
  id: string
  nome: string
  email: string
  reset_token: string | null
  reset_token_expires: string | null
  [key: string]: any
}

export default function AlterarSenhaPage() {
  const searchParams = useSearchParams()
  const router = useRouter()
  const oobCode = searchParams.get("oobCode") // Firebase usa oobCode para reset de senha
  const primeiroLogin = searchParams.get("primeiro_login") === "true"
  const emailParam = searchParams.get("email")

  const [novaSenha, setNovaSenha] = useState("")
  const [confirmarSenha, setConfirmarSenha] = useState("")
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState("")
  const [success, setSuccess] = useState(false)
  const [tokenValid, setTokenValid] = useState<boolean | null>(null)
  const [userName, setUserName] = useState("")
  const [userEmail, setUserEmail] = useState("")
  const [showPassword, setShowPassword] = useState(false)
  const [showConfirmPassword, setShowConfirmPassword] = useState(false)

  useEffect(() => {
    if (primeiroLogin && emailParam) {
      // Fluxo de primeiro login
      validatePrimeiroLogin()
    } else if (oobCode) {
      // Fluxo de redefini√ß√£o de senha
      validateToken()
    } else {
      setError("Par√¢metros inv√°lidos na URL")
      setTokenValid(false)
    }
  }, [oobCode, primeiroLogin, emailParam])

  const validatePrimeiroLogin = async () => {
    try {
      console.log("üîç === VALIDANDO PRIMEIRO LOGIN ===")
      console.log("üìß Email:", emailParam)

      if (!emailParam) {
        setError("Email n√£o fornecido")
        setTokenValid(false)
        return
      }

      // Buscar dados do usu√°rio no Firestore
      const usuariosRef = collection(firestore, "usuarios")
      const q = query(usuariosRef, where("email", "==", emailParam.toLowerCase()))
      const querySnapshot = await getDocs(q)

      if (querySnapshot.empty) {
        setError("Usu√°rio n√£o encontrado no sistema")
        setTokenValid(false)
        return
      }

      const usuarioDoc = querySnapshot.docs[0]
      const usuario = usuarioDoc.data()

      // Verificar se √© realmente primeiro login
      if (!usuario.primeiro_login) {
        setError("Este n√£o √© um primeiro login")
        setTokenValid(false)
        return
      }

      setUserEmail(emailParam)
      setUserName(usuario.nome || "Usu√°rio")
      setTokenValid(true)

    } catch (err: any) {
      console.error("‚ùå Erro ao validar primeiro login:", err)
      setError("Erro ao validar primeiro login")
      setTokenValid(false)
    }
  }

  const validateToken = async () => {
    try {
      console.log("üîç === VALIDANDO TOKEN DE REDEFINI√á√ÉO ===")
      console.log("üîë C√≥digo recebido:", oobCode)

      if (!oobCode || oobCode.length < 10) {
        console.error("‚ùå C√≥digo inv√°lido ou muito curto")
        setError("C√≥digo de redefini√ß√£o inv√°lido")
        setTokenValid(false)
        return
      }

      // Verificar se o c√≥digo √© v√°lido usando Firebase
      const email = await verifyPasswordResetCode(firebaseAuth, oobCode)
      console.log("‚úÖ C√≥digo v√°lido para email:", email)
      
      setUserEmail(email)
      setUserName("Usu√°rio") // Nome ser√° buscado do Firestore se necess√°rio
      setTokenValid(true)

    } catch (err: any) {
      console.error("‚ùå Erro ao validar c√≥digo:", err)
      if (err.code === "auth/invalid-action-code") {
        setError("C√≥digo de redefini√ß√£o inv√°lido ou expirado")
      } else if (err.code === "auth/expired-action-code") {
        setError("C√≥digo de redefini√ß√£o expirado. Solicite um novo link.")
      } else {
        setError("Erro ao validar c√≥digo de redefini√ß√£o")
      }
      setTokenValid(false)
    }
  }

  const validatePassword = (password: string): string[] => {
    const errors: string[] = []

    if (password.length < 8) {
      errors.push("A senha deve ter pelo menos 8 caracteres")
    }
    if (!/[A-Z]/.test(password)) {
      errors.push("A senha deve conter pelo menos uma letra mai√∫scula")
    }
    if (!/[a-z]/.test(password)) {
      errors.push("A senha deve conter pelo menos uma letra min√∫scula")
    }
    if (!/[0-9]/.test(password)) {
      errors.push("A senha deve conter pelo menos um n√∫mero")
    }
    if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
      errors.push("A senha deve conter pelo menos um caractere especial")
    }

    return errors
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError("")

    try {
      console.log("üîÑ Iniciando altera√ß√£o de senha")

      // Validar senhas
      if (novaSenha !== confirmarSenha) {
        setError("As senhas n√£o coincidem")
        setLoading(false)
        return
      }

      const passwordErrors = validatePassword(novaSenha)
      if (passwordErrors.length > 0) {
        setError(passwordErrors.join(". "))
        setLoading(false)
        return
      }

      if (primeiroLogin) {
        // Fluxo de primeiro login - criar usu√°rio no Firebase Auth e atualizar Firestore
        console.log("üÜï Primeiro login - criando usu√°rio no Firebase Auth e atualizando Firestore")
        
        const usuariosRef = collection(firestore, "usuarios")
        const q = query(usuariosRef, where("email", "==", userEmail.toLowerCase()))
        const querySnapshot = await getDocs(q)
        
        if (querySnapshot.empty) {
          setError("Usu√°rio n√£o encontrado")
          setLoading(false)
          return
        }

        const usuarioDoc = querySnapshot.docs[0]
        const usuario = usuarioDoc.data()
        
        try {
          // Criar usu√°rio no Firebase Auth
          console.log("üîê Criando usu√°rio no Firebase Auth...")
          console.log("üìß Email:", userEmail)
          const userCredential = await createUserWithEmailAndPassword(firebaseAuth, userEmail, novaSenha)
          console.log("‚úÖ Usu√°rio criado no Firebase Auth com UID:", userCredential.user.uid)
          
          // Criptografar senha para salvar no Firestore (backup)
          const hashedPassword = await hashPassword(novaSenha)
          
          // Atualizar dados no Firestore
          await updateDoc(usuarioDoc.ref, {
            senha: hashedPassword,
            primeiro_login: false,
            updated_at: new Date().toISOString(),
          })
          
          console.log("‚úÖ Dados atualizados no Firestore para primeiro login")
        } catch (authError: any) {
          console.error("‚ùå Erro ao criar usu√°rio no Firebase Auth:", authError)
          
          if (authError.code === "auth/email-already-in-use") {
            // Usu√°rio j√° existe no Firebase Auth, apenas atualizar senha
            console.log("‚ö†Ô∏è Usu√°rio j√° existe no Firebase Auth, atualizando senha...")
            
            // Criptografar senha para salvar no Firestore
            const hashedPassword = await hashPassword(novaSenha)
            
            await updateDoc(usuarioDoc.ref, {
              senha: hashedPassword,
              primeiro_login: false,
              updated_at: new Date().toISOString(),
            })
            
            console.log("‚úÖ Senha atualizada no Firestore (usu√°rio j√° existia no Auth)")
          } else {
            throw authError
          }
        }
      } else {
        // Fluxo de redefini√ß√£o de senha
        if (!oobCode || typeof oobCode !== 'string') {
          setError("C√≥digo de redefini√ß√£o inv√°lido.")
          setLoading(false)
          return
        }

        // Resetar senha no Firebase Auth usando o c√≥digo
        await confirmPasswordReset(firebaseAuth, oobCode, novaSenha)
        console.log("‚úÖ Senha alterada no Firebase Auth")

        // Atualizar campos adicionais no Firestore (se necess√°rio)
        try {
          const usuariosRef = collection(firestore, "usuarios")
          const q = query(usuariosRef, where("email", "==", userEmail.toLowerCase()))
          const querySnapshot = await getDocs(q)
          
          if (!querySnapshot.empty) {
            const usuarioDoc = querySnapshot.docs[0]
            await updateDoc(usuarioDoc.ref, {
              primeiro_login: false,
              updated_at: new Date().toISOString(),
            })
            console.log("‚úÖ Dados do usu√°rio atualizados no Firestore")
          }
        } catch (firestoreError) {
          console.warn("‚ö†Ô∏è Erro ao atualizar dados no Firestore:", firestoreError)
          // N√£o falha o processo se n√£o conseguir atualizar o Firestore
        }
      }

      // Enviar email de confirma√ß√£o via API route
      console.log("üìß Enviando email de confirma√ß√£o...")
      try {
        await sendEmailClient({
          type: "password-changed",
          to: userEmail,
          nome: userName,
        })
      } catch (emailError) {
        console.warn("‚ö†Ô∏è Erro ao enviar email de confirma√ß√£o:", emailError)
        // N√£o falha o processo se n√£o conseguir enviar o email
      }

      setSuccess(true)
    } catch (err: any) {
      console.error("‚ùå Erro ao alterar senha:", err)
      if (err.code === "auth/invalid-action-code") {
        setError("C√≥digo de redefini√ß√£o inv√°lido ou expirado")
      } else if (err.code === "auth/expired-action-code") {
        setError("C√≥digo de redefini√ß√£o expirado. Solicite um novo link.")
      } else if (err.code === "auth/weak-password") {
        setError("A senha √© muito fraca. Escolha uma senha mais forte.")
      } else {
        setError("Erro interno. Tente novamente.")
      }
    } finally {
      setLoading(false)
    }
  }

  const handleGoToDashboard = async () => {
    try {
      console.log("üîÑ === INICIANDO REDIRECIONAMENTO ===")
      console.log("üìß Email:", userEmail)
      console.log("üîë Primeiro Login:", primeiroLogin)
      
      // Se for primeiro login, fazer login autom√°tico
      if (primeiroLogin) {
        console.log("üîê Fazendo login autom√°tico...")
        console.log("üìß Email para login:", userEmail)
        console.log("üîë Senha para login:", novaSenha ? "***" + novaSenha.slice(-3) : "vazia")
        
        const userCredential = await signInWithEmailAndPassword(firebaseAuth, userEmail, novaSenha)
        console.log("‚úÖ Login autom√°tico realizado com sucesso")
        console.log("üÜî UID do usu√°rio:", userCredential.user.uid)
        console.log("üìß Email do usu√°rio:", userCredential.user.email)
      }
      
      console.log("üîÑ Redirecionando para /dashboard...")
      router.push('/dashboard')
      console.log("‚úÖ Redirecionamento iniciado")
      
    } catch (error) {
      console.error("‚ùå Erro ao fazer login autom√°tico:", error)
      console.log("üîÑ Redirecionando para login manual...")
      // Se falhar o login autom√°tico, redirecionar para login
      router.push('/')
    }
  }

  if (tokenValid === null) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: "#06459a" }}>
        <Card className="w-full max-w-md mx-4">
          <CardContent className="p-6 text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
            <p className="mt-2 text-gray-600">
              {primeiroLogin ? "üîç Validando primeiro login..." : "üîç Validando c√≥digo..."}
            </p>
          </CardContent>
        </Card>
      </div>
    )
  }

  if (tokenValid === false) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: "#06459a" }}>
        <Card className="w-full max-w-4xl mx-4">
          <CardHeader className="text-center">
            <AlertCircle className="h-12 w-12 text-red-500 mx-auto mb-4" />
            <CardTitle style={{ color: "#06459a" }}>
              {primeiroLogin ? "‚ùå Erro no Primeiro Login" : "‚ùå C√≥digo Inv√°lido"}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>{error}</AlertDescription>
            </Alert>
            <div className="mt-4 text-center">
              <Button
                onClick={() => router.push('/')}
                style={{ backgroundColor: "#06459a", color: "#ffffff" }}
              >
                Voltar ao Login
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    )
  }

  if (success) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: "#06459a" }}>
        <Card className="w-full max-w-md mx-4">
          <CardHeader className="text-center">
            <CheckCircle className="h-12 w-12 text-green-500 mx-auto mb-4" />
            <CardTitle style={{ color: "#06459a" }}>
              {primeiroLogin ? "‚úÖ Senha Criada!" : "‚úÖ Senha Alterada!"}
            </CardTitle>
          </CardHeader>
          <CardContent className="text-center">
            <p className="text-gray-600 mb-4">
              {primeiroLogin 
                ? <>Parab√©ns, <strong>{userName}</strong>! Sua senha foi criada com sucesso.</>
                : <>Parab√©ns, <strong>{userName}</strong>! Sua senha foi alterada com sucesso.</>
              }
            </p>
            <p className="text-sm text-gray-600 mb-4">
              {primeiroLogin 
                ? "Voc√™ ser√° redirecionado automaticamente para o dashboard."
                : "Agora voc√™ pode fazer login com sua nova senha."
              }
            </p>
            <Button
              onClick={primeiroLogin ? handleGoToDashboard : () => router.push('/')}
              style={{ backgroundColor: "#06459a", color: "#ffffff" }}
            >
              {primeiroLogin ? "Ir para o Dashboard" : "Ir para o Login"}
            </Button>
          </CardContent>
        </Card>
      </div>
    )
  }

  return (
    <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: "#06459a" }}>
      <Card className="w-full max-w-md mx-4">
        <CardHeader className="text-center">
          <CardTitle style={{ color: "#06459a" }}>
            {primeiroLogin ? "üîë Criar Senha" : "üîë Alterar Senha"}
          </CardTitle>
          {primeiroLogin && (
            <p className="text-sm text-gray-600">
              Ol√°, <strong>{userName}</strong>! Crie sua primeira senha.
            </p>
          )}
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="novaSenha">
                {primeiroLogin ? "Nova Senha" : "Nova Senha"}
              </Label>
              <div className="relative">
                <Input
                  id="novaSenha"
                  type={showPassword ? "text" : "password"}
                  value={novaSenha}
                  onChange={(e) => setNovaSenha(e.target.value)}
                  required
                  placeholder={primeiroLogin ? "Digite sua nova senha" : "Digite sua nova senha"}
                />
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  className="absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent"
                  onClick={() => setShowPassword(!showPassword)}
                >
                  {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                </Button>
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="confirmarSenha">
                {primeiroLogin ? "Confirmar Senha" : "Confirmar Nova Senha"}
              </Label>
              <div className="relative">
                <Input
                  id="confirmarSenha"
                  type={showConfirmPassword ? "text" : "password"}
                  value={confirmarSenha}
                  onChange={(e) => setConfirmarSenha(e.target.value)}
                  required
                  placeholder={primeiroLogin ? "Confirme sua senha" : "Confirme sua nova senha"}
                />
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  className="absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent"
                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                >
                  {showConfirmPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                </Button>
              </div>
            </div>

            {error && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>{error}</AlertDescription>
              </Alert>
            )}

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <p className="text-sm text-blue-800 font-semibold mb-2">üìã Requisitos da senha:</p>
              <ul className="text-xs text-blue-700 space-y-1">
                <li>‚Ä¢ Pelo menos 8 caracteres</li>
                <li>‚Ä¢ Pelo menos uma letra mai√∫scula</li>
                <li>‚Ä¢ Pelo menos uma letra min√∫scula</li>
                <li>‚Ä¢ Pelo menos um n√∫mero</li>
                <li>‚Ä¢ Pelo menos um caractere especial (!@#$%^&*)</li>
              </ul>
            </div>

            <Button
              type="submit"
              disabled={loading}
              className="w-full"
              style={{ backgroundColor: "#06459a", color: "#ffffff" }}
            >
              {loading 
                ? "üîÑ Processando..." 
                : primeiroLogin 
                ? "üîë Criar Senha" 
                : "üîë Alterar Senha"
              }
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
